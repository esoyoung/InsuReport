# Gemini API 할당량 관리 전략

## 📊 현재 문제

### Gemini 무료 할당량
```
분당 요청: 15 RPM (Requests Per Minute)
분당 토큰: 1M TPM (Tokens Per Minute)
일일 요청: 1,500 RPD (Requests Per Day)
```

### 대용량 PDF의 토큰 소비
```
6MB PDF ≈ 30,000 토큰 (입력)
AI 검증 1회 ≈ 35,000 토큰 (입력+출력)

→ 분당 28회 가능 (토큰 기준)
→ 하지만 RPM은 15회 제한!
```

---

## 🎯 전략 1: 크기별 차등 처리 (권장)

### 로직
```javascript
if (fileSize <= 2.8MB) {
  // 직접 업로드 → AI 검증 O
  upload via Vercel → Gemini API
}
else if (fileSize <= 10MB) {
  // R2 업로드 → AI 검증 O (대용량이지만 중요)
  upload to R2 → Gemini API
}
else {
  // 초대용량 → AI 검증 X (규칙 기반만)
  upload to R2 → Skip AI (save quota)
}
```

### 장점
- ✅ 소량 PDF: AI 검증 보장
- ✅ 중량 PDF (≤10MB): AI 검증 시도
- ✅ 초대용량 (>10MB): 할당량 절약
- ✅ 할당량 효율적 사용

---

## 🎯 전략 2: 사용자 선택 옵션

### UI 개선
```
[ ] AI 검증 활성화 (더 정확하지만 느림)
    ℹ️ 대용량 PDF는 AI 검증에 시간이 걸립니다.
```

### 장점
- ✅ 사용자가 선택 가능
- ✅ 급할 때 AI 스킵 가능
- ✅ 할당량 유연하게 관리

---

## 🎯 전략 3: 큐 시스템 (고급)

### 아키텍처
```
클라이언트
    ↓
업로드 + 파싱 (즉시)
    ↓
AI 검증 큐 등록
    ↓
백그라운드 워커 (Rate Limit 준수)
    ↓
결과 알림 (이메일/푸시)
```

### 장점
- ✅ 할당량 초과 없음
- ✅ 대량 처리 가능
- ❌ 구현 복잡도 높음

---

## 💰 전략 4: 유료 전환 (가장 간단)

### Google Cloud 결제 설정
```
무료: 15 RPM, 1M TPM
유료: 2,000 RPM, 4M TPM (133배!)

비용: 대용량 PDF 1건 = ~$0.002
      월 100건 = ~$0.20
      월 1000건 = ~$2.00
```

### 장점
- ✅ 할당량 걱정 없음
- ✅ 구현 변경 불필요
- ✅ 안정적인 서비스
- ❌ 월 ~$2 비용

---

## 🔢 시나리오 분석

### Case 1: 2.5MB 이하 PDF 여러 개

**현재 (무료):**
```
2MB PDF × 15개 = 15 RPM 한도
→ 1분에 15개까지 OK ✅
→ 16개째부터 대기 필요
```

**유료:**
```
2MB PDF × 2000개 = 2000 RPM 한도
→ 1분에 2000개까지 OK ✅
```

### Case 2: 6MB PDF 여러 개

**현재 (무료):**
```
6MB PDF (R2 경로)
→ AI 검증 시도
→ 토큰: 35,000/request
→ 분당 28개 가능 (토큰 기준)
→ 하지만 RPM 15개 제한! ⚠️
```

**제안 (전략 1):**
```
6MB PDF → R2 업로드 ✅
       → AI 검증 선택적
       → 10MB 이하만 AI 검증
       → 할당량 절약
```

### Case 3: 혼합 사용

**시나리오:**
```
2MB PDF × 10개 (AI 검증)
6MB PDF × 5개 (R2 + AI 검증)
→ 총 15개 = 15 RPM 한도 딱 맞음 ✅
```

**16개부터:**
```
429 Too Many Requests 오류
→ 10초 대기 후 재시도
→ 또는 유료 전환
```

---

## 🎯 권장 솔루션

### 단기 (무료 유지)

**전략 1 구현: 10MB 이상 AI 스킵**

```javascript
// FileUploader.jsx
const useAIValidation = fileSizeMB <= 10; // 10MB 이하만 AI 검증

if (useAIValidation && isAIValidationAvailable()) {
  // AI 검증 시도
} else {
  console.log('📊 대용량 PDF, 규칙 기반 파싱만 사용');
  // AI 검증 스킵
}
```

**장점:**
- ✅ 할당량 효율적 사용
- ✅ 소량 PDF는 AI 검증 보장
- ✅ 비용 $0

### 중기 (유료 전환)

**Google Cloud 결제 + Pay-as-you-go**

**장점:**
- ✅ 모든 PDF AI 검증 가능
- ✅ 할당량 걱정 없음
- ✅ 월 ~$2 (100건 기준)

---

## 📝 구현 우선순위

### Phase 1: 즉시 (무료)
```
✅ R2 시스템 완료
⏳ 10MB 이상 AI 스킵 로직 추가
⏳ 사용자에게 안내 메시지
```

### Phase 2: 1주일 내 (선택)
```
⏳ 사용자 선택 옵션 UI 추가
⏳ 할당량 사용 현황 표시
⏳ 대기 큐 시스템 (선택)
```

### Phase 3: 필요시 (유료)
```
⏳ Gemini API 유료 전환
⏳ Google Cloud 결제 설정
⏳ 할당량 모니터링
```

---

## 🎬 결론

### 지금 당장 (무료로 사용)
1. **10초 대기 후 재시도**
2. **2.8MB 이하 PDF만 AI 검증** (또는 10MB 이하)
3. **대용량은 규칙 기반만**

### 앞으로 (프로덕션)
1. **Gemini API 유료 전환** (~$2/월)
2. **모든 PDF AI 검증 가능**
3. **할당량 걱정 없음**

---

## 💡 사용자를 위한 가이드

### 현재 무료 플랜 사용 시 팁

**빠른 처리:**
```
✅ 2.5MB 이하 PDF → 빠른 AI 검증
⚠️ 6MB 이상 PDF → 규칙 기반만
💡 여러 파일: 분당 15개까지
```

**분할 업로드:**
```
대용량 PDF → 분할 (챕터별)
→ 각각 AI 검증 가능
→ 할당량 효율적 사용
```

**시간 간격:**
```
1분에 15개 제한
→ 대량 업로드 시 1분 간격
→ 또는 유료 전환
```
