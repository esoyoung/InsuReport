# 🚀 Cloudflare 마이그레이션 계획

## 📊 현재 상황 (Vercel)

### 문제점
1. **504 Gateway Timeout** - AI가 60초를 초과하면 서비스 불가능
2. **확장 불가** - 더 많은 섹션 추가 시 60초 초과 가능성 높음
3. **비용** - Pro 플랜 $20/월 필요

### 제한사항
| 플랜 | Duration | 비용 | 상태 |
|------|----------|------|------|
| Hobby | 10초 | $0 | ❌ 불가능 |
| **Pro** | **60초** | **$20/월** | ⚠️ **간신히 작동** |
| Enterprise | 300초 | 협상 | 💸 매우 비쌈 |

---

## ✅ 해결책 (Cloudflare Workers)

### 핵심 장점
1. **5분 CPU Time** - AI 처리 충분 (60초 → 300초, **5배 증가**)
2. **Wall Time 무제한** - 클라이언트 연결 유지 시 계속 실행
3. **저렴한 비용** - Paid 플랜 $5/월 (Vercel의 1/4)
4. **R2 직접 통합** - 같은 플랫폼에서 스토리지 + 컴퓨팅

### 비교표
| 항목 | Vercel Pro | Cloudflare Paid | 개선 |
|------|------------|-----------------|------|
| Max CPU Time | 60초 | **300초** | **5배** |
| Wall Time | 60초 | **무제한** | **무제한** |
| 가격 | $20/월 | **$5/월** | **75% 절감** |
| R2 통합 | HTTP | 직접 바인딩 | 빠름 |
| Cold Start | ~1초 | ~50ms | 빠름 |

---

## 🏗️ 아키텍처 변경

### Before (Vercel)
```
┌─────────────────────────────────────────────┐
│         Vercel (Frontend + API)             │
│  - React App                                │
│  - Serverless Functions (60초 제한!)        │
│  - R2 HTTP 접근                             │
└──────────────────┬──────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────┐
│       Cloudflare R2 (PDF Storage)           │
│  - HTTP로 접근 (느림)                        │
└─────────────────────────────────────────────┘
```

### After (Cloudflare Full-Stack)
```
┌─────────────────────────────────────────────┐
│      Cloudflare Pages (Frontend)            │
│  - React App (정적 파일)                     │
│  - Functions (Page Functions, 5분 제한)     │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│       Cloudflare Workers (AI API)           │
│  - /api/validate-contracts-r2               │
│  - CPU Time: 300초 (5분!)                   │
│  - R2 직접 바인딩 (빠름)                    │
└──────────────────┬──────────────────────────┘
                   │
┌──────────────────▼──────────────────────────┐
│       Cloudflare R2 (PDF Storage)           │
│  - Workers 직접 접근 (지연 없음)            │
└─────────────────────────────────────────────┘
```

---

## 📋 마이그레이션 단계

### Phase 1: POC 테스트 (현재) ✅
- [x] Cloudflare Workers 기본 구조 생성
- [x] Gemini API 통합
- [x] R2 바인딩 설정
- [ ] 로컬 테스트
- [ ] Cloudflare 배포
- [ ] 실제 PDF로 테스트

**예상 소요 시간:** 1-2시간

### Phase 2: 프론트엔드 연동 (1주)
- [ ] Vercel → Cloudflare Workers API 호출 변경
- [ ] CORS 설정
- [ ] 에러 핸들링
- [ ] 로딩 UI 개선 (5분 대응)

**예상 소요 시간:** 2-3일

### Phase 3: Cloudflare Pages 마이그레이션 (1주)
- [ ] React 앱을 Cloudflare Pages로 배포
- [ ] Pages Functions 설정
- [ ] 도메인 연결
- [ ] 환경 변수 설정

**예상 소요 시간:** 3-4일

### Phase 4: 프로덕션 전환 (1-2일)
- [ ] DNS 변경
- [ ] 성능 모니터링
- [ ] Vercel 플랜 다운그레이드/해지
- [ ] 비용 절감 확인

**예상 소요 시간:** 1-2일

**총 예상 기간:** 2-3주

---

## 💰 비용 분석

### 월간 비용 비교 (1,000 PDF 처리 기준)

#### Vercel (현재)
- Pro 플랜: $20/월
- R2 Storage: ~$0.10
- R2 Operations: ~$0.005
- **총: $20.11/월**

#### Cloudflare (마이그레이션 후)
- Workers Paid: $5/월
- Pages: $0 (무제한 무료)
- R2 Storage: ~$0.10
- R2 Operations: ~$0.005
- **총: $5.11/월**

#### 절감액
- 월간: **$15 절감 (75%)**
- 연간: **$180 절감**

---

## 🎯 성능 예상

### AI 처리 시간
| PDF 크기 | Vercel Pro (60초 제한) | Cloudflare (300초 제한) |
|----------|------------------------|-------------------------|
| 10페이지 | 20-30초 ✅ | 20-30초 ✅ |
| 21페이지 | 50-60초 ⚠️ | 50-60초 ✅ |
| 50페이지 | **타임아웃 ❌** | 120-150초 ✅ |
| 100페이지 | **타임아웃 ❌** | 180-240초 ✅ |

### 핵심 개선
- **현재:** 21페이지가 한계 (60초 제한)
- **이후:** 100페이지도 처리 가능 (300초 제한)
- **확장성:** 더 많은 섹션 추가 가능

---

## ⚠️ 리스크 및 대응

### 1. Node.js API 호환성
**리스크:** Workers는 V8 isolate, 일부 Node API 미지원  
**대응:** 
- PDF 파싱은 클라이언트(브라우저)에서 수행
- Workers는 AI 검증만 담당
- Gemini API가 PDF 직접 읽음 (multimodal)

### 2. 학습 곡선
**리스크:** Cloudflare Workers/Wrangler 새로 배워야 함  
**대응:**
- 간단한 POC로 시작
- 단계적 마이그레이션
- 문서화 철저히

### 3. 배포 파이프라인
**리스크:** Vercel의 자동 배포보다 복잡  
**대응:**
- GitHub Actions 설정
- Wrangler CLI 활용
- 자동화 스크립트 작성

### 4. 다운타임
**리스크:** 마이그레이션 중 서비스 중단  
**대응:**
- Blue-Green 배포
- DNS 단계적 전환
- 롤백 계획 준비

---

## 🚦 Go/No-Go 결정 기준

### ✅ Go (마이그레이션 진행)
- [x] POC 테스트 성공 (5분 처리 확인)
- [ ] 실제 PDF로 검증 완료
- [ ] 성능이 Vercel과 동등 이상
- [ ] 비용 절감 확인 ($15/월 이상)

### ❌ No-Go (마이그레이션 보류)
- [ ] POC 테스트 실패
- [ ] 성능 저하 (처리 시간 증가)
- [ ] 치명적 버그 발견
- [ ] 비용이 예상보다 높음

---

## 📝 다음 액션 아이템

### 즉시 (오늘)
1. ✅ POC 코드 작성 완료
2. [ ] 로컬에서 Workers 실행
3. [ ] Health check 테스트
4. [ ] Cloudflare 계정 설정

### 내일
5. [ ] Gemini API 키 등록
6. [ ] R2 버킷 생성
7. [ ] 실제 PDF 업로드 및 테스트
8. [ ] 처리 시간 측정

### 이번 주
9. [ ] Vercel → Cloudflare API 연동
10. [ ] 프론트엔드 테스트
11. [ ] 성능 비교 분석
12. [ ] Go/No-Go 결정

---

## 🎉 예상 결과

### 단기 (1개월)
- ✅ AI 처리 시간 제약 해결 (60초 → 300초)
- ✅ 비용 절감 ($20 → $5)
- ✅ 안정적인 서비스 운영

### 중기 (3개월)
- ✅ 더 많은 섹션 추가 가능
- ✅ 대용량 PDF 지원 (100페이지+)
- ✅ 확장성 확보

### 장기 (6개월+)
- ✅ Cloudflare 풀스택 최적화
- ✅ 추가 기능 개발 여유
- ✅ 연간 $180 절감

---

**작성일:** 2025-11-25  
**상태:** POC Ready  
**승인 대기중**
