# PDF 크기 제한 및 압축 가이드

## 📏 크기 제한

### Vercel Serverless Function 제약
- **요청 페이로드 제한**: 4.5MB (Hobby & Pro 플랜 동일)
- **Base64 인코딩**: 원본 크기의 약 133% (33% 증가)
- **안전 마진**: 실제 전송 가능한 PDF는 약 3.4MB

### 현재 설정

| 단계 | 크기 제한 | 동작 |
|------|-----------|------|
| **업로드** | ≤ 2.5MB | 압축 없이 바로 처리 |
| **압축 트리거** | > 2.5MB | 자동 압축 시작 (목표: 2.0MB) |
| **AI 검증 제한** | ≤ 2.8MB | AI 검증 가능 |
| **최종 제한** | > 2.8MB | 규칙 기반 파싱만 사용 |

## 🔄 압축 프로세스

### 1. 자동 압축
```javascript
// 2.5MB 이상 PDF 업로드 시 자동 실행
if (file.size > 2.5MB) {
  compress(file, targetSize: 2.0MB)
}
```

### 2. 압축 방식
- ✅ **메타데이터 제거**: 제목, 저자, 키워드 등
- ✅ **구조 최적화**: 객체 스트림 압축
- ✅ **화질 유지**: 이미지 품질 손실 없음
- ✅ **재시도**: 목표 미달성 시 추가 압축

### 3. 예상 압축률

| 원본 크기 | 압축 후 (예상) | 감소율 | AI 검증 |
|-----------|----------------|--------|---------|
| 2.0MB | 압축 안함 | - | ✅ 가능 |
| 3.0MB | ~1.8MB | 40% | ✅ 가능 |
| 4.0MB | ~2.2MB | 45% | ✅ 가능 |
| 5.0MB | ~2.5MB | 50% | ✅ 가능 |
| 6.0MB | ~3.0MB | 50% | ⚠️ 규칙 기반만 |
| 8.0MB | ~4.0MB | 50% | ⚠️ 규칙 기반만 |

## 📊 실제 사례

### 성공적인 압축
```
원본: 안영균_kb보장분석.pdf (4.2MB)
  ↓
압축: 2.1MB (50% 감소)
  ↓
Base64: 2.8MB
  ↓
결과: ✅ AI 검증 성공
```

### 압축 실패
```
원본: 대용량_보장분석.pdf (10MB)
  ↓
압축: 5.2MB (48% 감소)
  ↓
결과: ⚠️ 여전히 2.8MB 초과
  ↓
대안: 규칙 기반 파싱 사용
```

## 💡 사용자 가이드

### PDF가 너무 큰 경우

#### Option 1: 자동 압축 사용 (권장)
- 시스템이 자동으로 압축 시도
- 대부분 50% 압축 성공
- 사용자 개입 불필요

#### Option 2: 수동 압축 후 업로드
PDF가 5MB 이상일 경우 수동 압축 권장:

1. **Adobe Acrobat**
   - 파일 → 다른 이름으로 저장 → 크기가 축소된 PDF

2. **온라인 도구**
   - [iLovePDF](https://www.ilovepdf.com/compress_pdf)
   - [SmallPDF](https://smallpdf.com/compress-pdf)

3. **macOS Preview**
   - 파일 → 내보내기 → Quartz 필터: Reduce File Size

#### Option 3: PDF 분할
- 10MB 이상 대용량 PDF는 분할 권장
- 각 파일별로 개별 업로드 및 분석

## 🎯 최적화 팁

### 효과적인 압축을 위한 팁
1. ✅ **고해상도 이미지 제거**: 스캔 품질을 낮춤
2. ✅ **불필요한 페이지 삭제**: 표지, 빈 페이지 등
3. ✅ **OCR 데이터 제거**: 검색 가능한 텍스트가 불필요한 경우
4. ✅ **주석/양식 제거**: 메모, 하이라이트 등

### 압축이 잘 안 되는 경우
- ❌ 이미 최적화된 PDF (재압축 효과 미미)
- ❌ 암호화된 PDF (압축 불가)
- ❌ 복잡한 벡터 그래픽 (압축률 낮음)

## 🔧 개발자 가이드

### 압축 설정 변경

**src/utils/pdfCompressor.js**
```javascript
// 목표 크기 변경
export async function compressPDF(file, targetSizeMB = 2.0)

// 트리거 임계값 변경
export function isPDFTooLarge(file, maxSizeMB = 2.5)
```

**src/utils/aiValidator.js**
```javascript
// AI 검증 최대 크기
const maxFileSize = 2.8 * 1024 * 1024; // 2.8MB
```

### 모니터링
브라우저 콘솔에서 확인 가능:
```
📦 0단계: PDF 크기가 큽니다. 압축 시도...
📄 원본 PDF 크기: 4.20MB
✅ 압축 완료: 4.20MB → 2.10MB (50.0% 감소)
📄 PDF 크기: 2150.00KB
🤖 Vercel Serverless Function으로 AI 검증 요청...
✅ AI 검증 완료
```

## ⚠️ 알려진 제한사항

1. **Vercel 제약**: 4.5MB 페이로드 제한 (변경 불가)
2. **Base64 오버헤드**: 33% 크기 증가 (피할 수 없음)
3. **압축률 변동**: PDF 내용에 따라 20-60% 범위
4. **처리 시간**: 대용량 PDF 압축에 5-10초 소요

## 🚀 향후 개선 계획

- [ ] 이미지 품질 조정 옵션 추가
- [ ] 페이지별 선택적 분석
- [ ] 외부 저장소(S3 등) 연동
- [ ] Streaming 업로드 지원
- [ ] PDF 분할 자동화
